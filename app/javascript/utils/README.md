# Apollo

## Apollo yarn dependencies:

`$ yarn add apollo-client apollo-cache-inmemory apollo-link-http apollo-link-error apollo-link graphql graphql-tag react-apollo`

- We use graphql-tag to build our first queries.
- apollo-client is a generic framework-agnostic package for performing and caching GraphQL requests.
- apollo-cache-inmemory is a storage implementation for Apollo cache.
- react-apollo contains a set of React components for displaying data.
- `apollo-link` and other links implement a middleware pattern for apollo-client operations (you can find further details [here](https://www.apollographql.com/docs/link/overview.html)).
- `apollo-codegen` can generate type signatures automatically (For use with Typescript)

## Apollo Cache

> Caching is one of the most powerful features of Apollo. Sometimes it becomes overpowering, and you might prefer a more straightforward solution. In any case, it’s worth learning how it works. Find more details about how Apollo caching works [here](https://www.apollographql.com/docs/react/advanced/caching.html).

> Each query response is put into the cache (the corresponding request is used to generate the cache key). Before making a request, apollo-client ensures that the response hasn’t been cached yet, and if it has been–the request is not performed. This behavior is configurable: for instance, we can turn off caching for a particular request or ask the client to look for a cache entry of a different query.

> [...]A cache key is a concatenation of the object `id` and `__typename`. Thus, fetching the same object twice would result only in one request.

> Since we use HTTP POST as a transport, we need to attach a proper CSRF token to every request to pass the forgery protection check in the Rails app. We can grab it from `meta[name="csrf-token"]` (which is generated by `<%= csrf_meta_tags %>`)

## Apollo Subscriptions

- We create a new Apollo link for subscriptions inside `createActionCableLink`
- We decide where to send our data inside `ApolloLink.split`
- If `hasSubscriptionOperation` returns true, the operation will be sent to `actionCableLink`